<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Article – Physio Therapy</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/styles3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.5.0/font/bootstrap-icons.min.css">

  <!-- Hero & breadcrumb tweaks -->
  <style>
    .hero-banner{
      height:45vh;
      background-size:cover;
      background-position: top center;        /* default */
      background-repeat:no-repeat;
      position:relative;
    }
    /* gentle fade-out into white at the bottom */
    .hero-banner::after{
      content:'';position:absolute;left:0;right:0;bottom:0;height:140px;
      background:linear-gradient(to bottom,rgba(255,255,255,0) 0%, #fff 100%);
      z-index:1;pointer-events:none;
    }
    .hero-banner .container{position:relative;z-index:2;}
    .hero-banner .overlay{display:none;}     /* remove dark overlay */

    /* Breadcrumb */
    .crumbbar { background:#f8f9fa; border-bottom:1px solid #eef2f7; }
    .breadcrumb a { text-decoration:none; color:inherit; }
    .breadcrumb a:hover { text-decoration:underline; }
  </style>

  <!-- Defaults that JS will overwrite -->
  <meta name="description" content="">
  <link rel="canonical" href="/">
  <meta property="og:type" content="article">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:url" content="/">
  <meta property="og:site_name" content="Physio Therapy">
  <meta property="og:image" content="">
  <meta property="og:image:width" content="1280">
  <meta property="og:image:height" content="720">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="">
</head>
<body>
  <!-- ===== TOP BAR ==================================================== -->
  <div class="top-bar text-white py-2">
    <div class="container d-flex justify-content-between">
      <div class="contact-info">
        <span><i class="bi bi-telephone"></i> 123 456 7890</span>
        <span class="mx-3"><i class="bi bi-envelope"></i> info@sitename.com</span>
      </div>
      <div class="social-icons d-none d-md-block">
        <a href="#"><i class="bi bi-facebook text-white mx-2"></i></a>
        <a href="#"><i class="bi bi-twitter text-white mx-2"></i></a>
        <a href="#"><i class="bi bi-linkedin text-white mx-2"></i></a>
        <a href="#"><i class="bi bi-instagram text-white mx-2"></i></a>
      </div>
    </div>
  </div>

  <!-- ===== NAVBAR ===================================================== -->
  <header class="bg-white py-3 shadow-sm sticky-top">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white" aria-label="Primary navigation">
        <a class="navbar-brand" href="/"><img src="images/logo.png" alt="Physio Therapy Logo" class="img-fluid"></a>

        <button class="navbar-toggler d-lg-none" type="button"
                data-bs-toggle="offcanvas" data-bs-target="#mobileMenu"
                aria-controls="mobileMenu" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <ul class="navbar-nav mx-auto d-none d-lg-flex gap-3">
          <li class="nav-item"><a class="nav-link text-dark" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link text-dark" href="/#about">About Us</a></li>
          <li class="nav-item"><a class="nav-link text-dark" href="/#services">Services</a></li>
          <li class="nav-item"><a class="nav-link text-dark" href="/#blog">Blog</a></li>
          <li class="nav-item"><a class="nav-link text-dark" href="/#contact">Contact</a></li>
        </ul>

        <a href="#" class="btn btn-primary d-none d-lg-inline-block">Book Appointment</a>
      </nav>
    </div>
  </header>

  <!-- ===== MOBILE OFF-CANVAS MENU ==================================== -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileMenuLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column justify-content-between">
      <ul class="navbar-nav gap-2">
        <li class="nav-item"><a class="nav-link" href="/" data-bs-dismiss="offcanvas">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/#about" data-bs-dismiss="offcanvas">About Us</a></li>
        <li class="nav-item"><a class="nav-link" href="/#services" data-bs-dismiss="offcanvas">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="/#blog" data-bs-dismiss="offcanvas">Blog</a></li>
        <li class="nav-item"><a class="nav-link" href="/#contact" data-bs-dismiss="offcanvas">Contact</a></li>
      </ul>
      <a href="#" class="btn btn-primary mt-4" data-bs-dismiss="offcanvas">Book Appointment</a>
    </div>
  </div>

  <!-- ===== HERO BANNER =============================================== -->
  <header id="heroBanner" class="hero-banner">
    <div class="overlay"></div>
    <div class="container h-100 d-flex align-items-end">
      <!-- Visible headline (microdata handled inside <article>) -->
      <h1 id="heroTitle" class="mb-4 display-5 text-dark"></h1>
    </div>
  </header>

  <!-- ===== BREADCRUMB (below hero) =================================== -->
  <section class="crumbbar py-2">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0" itemscope itemtype="https://schema.org/BreadcrumbList">
          <!-- Home -->
          <li class="breadcrumb-item"
              itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="/" itemprop="item"><span itemprop="name">Home</span></a>
            <meta itemprop="position" content="1">
          </li>
          <!-- Category (filled by JS) -->
          <li class="breadcrumb-item"
              id="bcCat"
              itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a id="bcCatLink" href="#" itemprop="item">
              <span id="bcCatName" itemprop="name">Category</span>
            </a>
            <meta itemprop="position" content="2">
          </li>
          <!-- Post title (filled by JS) -->
          <li class="breadcrumb-item active" aria-current="page"
              id="bcPost"
              itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span id="bcPostName" itemprop="name">Post</span>
            <meta itemprop="position" content="3">
          </li>
        </ol>
      </nav>
    </div>
  </section>

  <!-- ===== ARTICLE BODY ============================================= -->
  <main class="container py-5">
    <!-- Proper Article wrapper -->
    <article id="article" itemscope itemtype="https://schema.org/Article">
      <!-- Structured-data headline (kept inside the Article scope) -->
      <meta id="metaHeadline" itemprop="headline" content="">
      <div id="articleContent" itemprop="articleBody"></div>

      <!-- Hidden times for microdata (filled by JS) -->
      <time id="publishedTime" itemprop="datePublished" datetime="" hidden></time>
      <time id="modifiedTime"  itemprop="dateModified"  datetime="" hidden></time>
    </article>
  </main>

  <!-- ===== FOOTER / BACK-TO-TOP ===================================== -->
  <a href="#" class="back-to-top"><i class="bi bi-arrow-up-circle-fill"></i></a>

  <footer class="bg-dark text-white py-3 text-center">
    <p>© 2024 Physio Therapy. All rights reserved.</p>
  </footer>

  <!-- ===== JS ======================================================== -->
  <script src="bootstrap/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    const qs   = sel => document.querySelector(sel);
    const slug = new URLSearchParams(location.search).get('slug');
    if (!slug) location.href = '/';

    const SITE_NAME = 'Physio Therapy';
    const CAT_LABELS = { news:'News', service:'Services', tips:'Tips' };

    // Replace "-card.<ext>" with "-hero.<ext>" if possible
    function deriveHeroFromCard(url){
      if (!url) return '';
      return url.replace(/-card(\.(jpe?g|png|webp|avif))$/i, '-hero$1');
    }

    // SEO helpers
    function setMeta(name, content){
      if (content === undefined || content === null) return;
      let el = document.querySelector(`meta[name="${name}"]`);
      if (!el){ el = document.createElement('meta'); el.setAttribute('name', name); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }
    function setOG(prop, content){
      if (content === undefined || content === null) return;
      let el = document.querySelector(`meta[property="${prop}"]`);
      if (!el){ el = document.createElement('meta'); el.setAttribute('property', prop); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }
    function setCanonical(href){
      if (!href) return;
      let link = document.querySelector('link[rel="canonical"]');
      if (!link){ link = document.createElement('link'); link.setAttribute('rel','canonical'); document.head.appendChild(link); }
      link.setAttribute('href', href);
    }
    function ensureRobots(content){
      let el = document.querySelector('meta[name="robots"]');
      if (!el){ el = document.createElement('meta'); el.setAttribute('name','robots'); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }
    function textFromHTML(html){
      const div = document.createElement('div');
      div.innerHTML = html || '';
      return div.textContent || div.innerText || '';
    }
    function summarize(text, max=160){
      const t = (text || '').replace(/\s+/g,' ').trim();
      if (t.length <= max) return t;
      const cut = t.slice(0, max);
      const lastSpace = cut.lastIndexOf(' ');
      return (lastSpace > 60 ? cut.slice(0, lastSpace) : cut).trim() + '…';
    }
    function iso(dt){
      if (!dt) return '';
      // handle "YYYY-MM-DD HH:MM:SS" from SQLite
      const d = new Date(dt.replace(' ', 'T'));
      return isNaN(d) ? '' : d.toISOString();
    }
    function absoluteUrl(pathOrUrl){
      try { return new URL(pathOrUrl, location.origin).toString(); }
      catch { return location.href; }
    }

    (async () => {
      try {
        const r = await fetch(`/api/posts/${encodeURIComponent(slug)}`);
        if (!r.ok) throw new Error('404');
        const post = await r.json();

        /* ===== Title & hero ===== */
        document.title = `${post.title} – ${SITE_NAME}`;
        qs('#heroTitle').textContent = post.title;

        // Prefer hero_url → derived hero → image_url
        let hero = (post.hero_url && post.hero_url.trim())
          ? post.hero_url
          : deriveHeroFromCard(post.image_url) || post.image_url || '';

        if (hero) {
          qs('#heroBanner').style.backgroundImage = `url('${hero}')`;
          // Preload hero for perceived speed
          const preload = document.createElement('link');
          preload.rel = 'preload';
          preload.as  = 'image';
          preload.href= hero.startsWith('http') ? hero : (location.origin + hero);
          document.head.appendChild(preload);
        }

        // Honour hero_pos (top / center / bottom)
        const posMap = { top:'top center', center:'center center', bottom:'bottom center' };
        if (post.hero_pos && posMap[post.hero_pos]){
          qs('#heroBanner').style.backgroundPosition = posMap[post.hero_pos];
        }

        /* ===== Article body ===== */
        qs('#articleContent').innerHTML = post.content_html || '';
        // Structured headline inside Article scope
        const metaHeadline = document.getElementById('metaHeadline');
        if (metaHeadline) metaHeadline.setAttribute('content', post.title || '');

        // Microdata times
        const pubISO = iso(post.created_at);
        const modISO = iso(post.updated_at || post.created_at);
        if (pubISO) qs('#publishedTime').setAttribute('datetime', pubISO);
        if (modISO) qs('#modifiedTime').setAttribute('datetime',  modISO);

        /* ===== Breadcrumbs ===== */
        const catKey   = (post.category || 'news').toLowerCase();
        const catLabel = CAT_LABELS[catKey] || (post.category || 'Category');
        const catHref  = `/category.html?category=${encodeURIComponent(catKey)}`;

        const bcCatName = document.getElementById('bcCatName');
        const bcCatLink = document.getElementById('bcCatLink');
        const bcPostName= document.getElementById('bcPostName');

        if (bcCatName) bcCatName.textContent = catLabel;
        if (bcCatLink) bcCatLink.href = catHref;
        if (bcPostName) bcPostName.textContent = post.title;

        /* ===== SEO ===== */
        const canonical = (() => {
          const url = new URL(location.href);
          // keep only the slug param to avoid junk params
          [...url.searchParams.keys()].forEach(k => { if (k !== 'slug') url.searchParams.delete(k); });
          return url.toString();
        })();

        const absHero = hero ? absoluteUrl(hero) : (post.image_url ? absoluteUrl(post.image_url) : '');
        const description = summarize(post.excerpt || textFromHTML(post.content_html), 160);
        const catTitle = CAT_LABELS[(post.category || '').toLowerCase()] || (post.category || 'Article');

        setMeta('description', description);
        setCanonical(canonical);

        // Indexing: noindex drafts
        if (!post.published) ensureRobots('noindex, nofollow');
        else ensureRobots('index, follow');

        // Open Graph
        setOG('og:title',       post.title + ' – ' + SITE_NAME);
        setOG('og:description', description);
        setOG('og:url',         canonical);
        setOG('og:site_name',   SITE_NAME);
        setOG('og:type',        'article');
        if (absHero) {
          setOG('og:image', absHero);
          setOG('og:image:width',  '1280');
          setOG('og:image:height', '720');
        }
        setOG('article:section', catTitle);
        if (pubISO) setOG('article:published_time', pubISO);
        if (modISO) setOG('article:modified_time',  modISO);

        // Twitter Card
        setMeta('twitter:card',        'summary_large_image');
        setMeta('twitter:title',       post.title + ' – ' + SITE_NAME);
        setMeta('twitter:description', description);
        if (absHero) setMeta('twitter:image', absHero);

        // JSON‑LD: Article
        const articleLD = {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": post.title,
          "image": absHero || undefined,
          "datePublished": pubISO || undefined,
          "dateModified":  modISO || undefined,
          "articleSection": catTitle,
          "mainEntityOfPage": { "@type":"WebPage", "@id": canonical },
          "author": { "@type":"Organization", "name": SITE_NAME },
          "publisher": {
            "@type":"Organization",
            "name": SITE_NAME,
            "logo": { "@type":"ImageObject", "url": location.origin + "/images/logo.png" }
          },
          "description": description
        };
        const ld1 = document.createElement('script');
        ld1.type = 'application/ld+json';
        ld1.textContent = JSON.stringify(articleLD);
        document.head.appendChild(ld1);

        // JSON‑LD: BreadcrumbList
        const breadcrumbLD = {
          "@context":"https://schema.org",
          "@type":"BreadcrumbList",
          "itemListElement":[
            { "@type":"ListItem", "position":1, "name":"Home", "item": location.origin + "/" },
            { "@type":"ListItem", "position":2, "name": catLabel,
              "item": location.origin + "/category.html?category=" + encodeURIComponent(catKey) },
            { "@type":"ListItem", "position":3, "name": post.title, "item": canonical }
          ]
        };
        const ld2 = document.createElement('script');
        ld2.type = 'application/ld+json';
        ld2.textContent = JSON.stringify(breadcrumbLD);
        document.head.appendChild(ld2);

      } catch (err) {
        console.error(err);
        qs('#heroTitle').textContent = 'Article not found';
        qs('#articleContent')?.insertAdjacentHTML('afterbegin',
          '<p class="text-danger">Sorry, this article could not be loaded.</p>');
        ensureRobots('noindex, nofollow');
      }
    })();
  </script>
</body>
</html>
